services:
  edge:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: mini_pacs_edge
    depends_on:
      - postgres
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: mini_pacs
      POSTGRES_USER: mini_pacs
      POSTGRES_PASSWORD: mini_pacs
    ports:
      - "11112:11112"
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config.yaml:/app/config.yaml
    restart: unless-stopped
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: mini_pacs
      POSTGRES_USER: mini_pacs
      POSTGRES_PASSWORD: mini_pacs
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    restart: unless-stopped
  orthanc:
    image: orthancteam/orthanc:latest
    container_name: mini_pacs_orthanc
    ports:
      - "4242:4242"
      - "8042:8042"
    volumes:
      - ./data/orthanc:/var/lib/orthanc/db
      - ./orthanc.json:/etc/orthanc/orthanc.json
    environment:
      ORTHANC__HTTP_ACCESS_CONTROL_ALLOW_ORIGIN: "*"
      ORTHANC__HTTP_ACCESS_CONTROL_ALLOW_METHODS: "GET, POST, PUT, DELETE, OPTIONS"
      ORTHANC__HTTP_ACCESS_CONTROL_ALLOW_HEADERS: "Origin, Accept, Content-Type"
    restart: unless-stopped
  ohif:
    image: ohif/viewer:latest
    container_name: mini_pacs_ohif
    depends_on:
      - orthanc
    ports:
      - "3000:80"
    volumes:
      - ./ohif-app-config.js:/usr/share/nginx/html/app-config.js:ro
      - ./ohif-nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ohif-init-service-worker.js:/usr/share/nginx/html/init-service-worker.js:ro
    restart: unless-stopped
  app01:
    image: python:3.11-slim
    expose:
      - "8080"
    command:
      - python
      - -u
      - -c
      - |
        import time
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class Handler(BaseHTTPRequestHandler):
            def _handle(self):
                print("app01: received request", flush=True)
                time.sleep(0.2)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b"OK")

            do_GET = _handle
            do_POST = _handle

        HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
    restart: unless-stopped
  app02:
    image: python:3.11-slim
    expose:
      - "8080"
    command:
      - python
      - -u
      - -c
      - |
        import time
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class Handler(BaseHTTPRequestHandler):
            def _handle(self):
                print("app02: received request", flush=True)
                time.sleep(0.2)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b"OK")

            do_GET = _handle
            do_POST = _handle

        HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
    restart: unless-stopped
  app03:
    image: python:3.11-slim
    expose:
      - "8080"
    command:
      - python
      - -u
      - -c
      - |
        import time
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class Handler(BaseHTTPRequestHandler):
            def _handle(self):
                print("app03: received request", flush=True)
                time.sleep(0.2)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b"OK")

            do_GET = _handle
            do_POST = _handle

        HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
    restart: unless-stopped
  app04:
    image: python:3.11-slim
    expose:
      - "8080"
    command:
      - python
      - -u
      - -c
      - |
        import time
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class Handler(BaseHTTPRequestHandler):
            def _handle(self):
                print("app04: received request", flush=True)
                time.sleep(0.2)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b"OK")

            do_GET = _handle
            do_POST = _handle

        HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
    restart: unless-stopped
  app05:
    image: python:3.11-slim
    expose:
      - "8080"
    command:
      - python
      - -u
      - -c
      - |
        import time
        from http.server import BaseHTTPRequestHandler, HTTPServer

        class Handler(BaseHTTPRequestHandler):
            def _handle(self):
                print("app05: received request", flush=True)
                time.sleep(0.2)
                self.send_response(200)
                self.end_headers()
                self.wfile.write(b"OK")

            do_GET = _handle
            do_POST = _handle

        HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
    restart: unless-stopped
